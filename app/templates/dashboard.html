{% extends "layout.html" %}

{% block title %}Dashboard - MeuBolso{% endblock %}

{% block content %}
<header class="dashboard-header">
    <h1 class="page-title">Dashboard</h1>
    <div class="month-selector">
        <form id="filter-form" method="get" action="{{ url_for('main.dashboard') }}">
            <select name="month" id="month-select" class="rounded-select" onchange="document.getElementById('filter-form').submit()">
                {% for i in range(1, 13) %}
                    <option value="{{ i }}" {% if i == selected_month %}selected{% endif %}>{{ month_names[i-1] }}</option>
                {% endfor %}
            </select>
            <select name="year" id="year-select" class="rounded-select" onchange="document.getElementById('filter-form').submit()">
                {% for year in years %}
                    <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</header>

<section class="summary-cards">
    <div class="card">
        <div class="card-icon icon-saldo">
            <i class="fas fa-eye"></i>
        </div>
        <div class="card-content">
            <span>Saldo atual</span>
            <h2>R$ {{ "%.2f"|format(balance) }}</h2>
        </div>
    </div>
    <div class="card">
        <div class="card-icon icon-receitas">
            <i class="fas fa-arrow-up"></i>
        </div>
        <div class="card-content">
            <span>Receitas</span>
            <h2>R$ {{ "%.2f"|format(total_income) }}</h2>
        </div>
    </div>
    <div class="card">
        <div class="card-icon icon-despesas">
            <i class="fas fa-arrow-down"></i>
        </div>
        <div class="card-content">
            <span>Despesas</span>
            <h2>R$ {{ "%.2f"|format(total_expense) }}</h2>
        </div>
    </div>
    <div class="card">
        <div class="card-icon icon-cartao">
            <i class="fas fa-credit-card"></i>
        </div>
        <div class="card-content">
            <span>Despesa no Cartão (Mês)</span>
            <h2>R$ {{ "%.2f"|format(credit_card_bill) }}</h2>
        </div>
    </div>
</section>

<section class="main-sections">
    <div class="section-card">
        <h3>Últimas Transações</h3>
        <ul class="transaction-list">
            {% for transaction in transactions %}
            <li data-id="{{ transaction.id }}">
                <div class="transaction-icon" style="background-color: {% if transaction.type == 'income' %}#e0f2f1{% else %}#fce4ec{% endif %}; color: {% if transaction.type == 'income' %}#00796b{% else %}#d81b60{% endif %};">
                    <i class="fas fa-{% if transaction.type == 'income' %}briefcase{% else %}shopping-cart{% endif %}"></i>
                </div>
                <div class="transaction-info">
                    <strong>{{ transaction.description }}</strong>
                    <span>{{ transaction.date|format_date }} - {{ transaction.payment_method }}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="text-blue-500 hover:text-blue-700 edit-btn" onclick="showEditModal({{ transaction.id }}, '{{ transaction.description }}', '{{ "%.2f"|format(transaction.amount) }}', '{{ transaction.payment_method }}', '{{ transaction.category }}', '{{ transaction.type }}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-500 hover:text-red-700 delete-btn" onclick="showDeleteConfirm({{ transaction.id }})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <span class="transaction-value {% if transaction.type == 'income' %}text-success{% else %}text-danger{% endif %}">
                        {% if transaction.type == 'income' %}+{% else %}-{% endif %} R$ {{ "%.2f"|format(transaction.amount) }}
                    </span>
                </div>
            </li>
            {% else %}
            <li>
                <p class="no-data">Nenhuma transação registrada ainda.</p>
            </li>
            {% endfor %}
        </ul>
        <form id="clear-data-form" method="POST" action="{{ url_for('main.clear_data') }}" class="mt-4" onsubmit="return confirm('Tem certeza que deseja apagar todos os dados de transação? Esta ação é irreversível.');">
            <button type="submit" class="btn-clear-data">Limpar Todos os Dados</button>
        </form>
    </div>
    
    <div class="section-card">
        <h3>Gerenciamento de Cartões de Crédito</h3>
        <div class="tabs">
            <button class="tab-btn active">Cartões Cadastrados</button>
        </div>
        <ul class="invoice-list">
            {% for card in cards %}
            <li>
                <div class="invoice-icon"><i class="fas fa-credit-card"></i></div>
                <div class="invoice-info">
                    <strong>{{ card.name }}</strong>
                    <span>Vencimento: Dia {{ card.due_day }}</span>
                    {% set invoice_data = invoices.closed | selectattr('card_id', 'equalto', card.id) | first %}
                    {% if invoice_data %}
                        <span class="text-danger">Despesa no Mês: R$ {{ "%.2f"|format(invoice_data.amount) }}</span>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-2">
                    <button class="text-blue-500 hover:text-blue-700 edit-card-btn" onclick="showEditCardModal({{ card.id }})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-500 hover:text-red-700 delete-card-btn" onclick="showDeleteCardConfirm({{ card.id }})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </li>
            {% else %}
            <li>
                <p class="no-data">Nenhum cartão de crédito cadastrado.</p>
            </li>
            {% endfor %}
        </ul>
    </div>
    </section>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="hideEditModal()">&times;</span>
        <h2>Editar Transação</h2>
        <form id="edit-form" onsubmit="submitEdit(event)">
            <input type="hidden" id="edit-id">
            <label for="edit-description">Descrição:</label>
            <input type="text" id="edit-description" required>
            
            <label for="edit-amount">Valor:</label>
            <input type="number" step="0.01" id="edit-amount" required>

            <label for="edit-type">Tipo:</label>
            <select id="edit-type" required>
                <option value="income">Receita</option>
                <option value="expense">Despesa</option>
            </select>
            
            <label for="edit-payment">Método de Pagamento:</label>
            <select id="edit-payment" required>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Transferencia">Transferência</option>
                <option value="Cartao de Credito">Cartão de Crédito</option>
            </select>

            <label for="edit-category">Categoria:</label>
            <select id="edit-category" required>
                </select>

            <button type="submit" class="btn-edit-submit">Salvar Alterações</button>
        </form>
    </div>
</div>

<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="hideConfirmModal()">&times;</span>
        <h2>Confirmar Exclusão</h2>
        <p>Tem certeza que deseja deletar esta transação?</p>
        <div class="flex justify-end space-x-4 mt-4">
            <button class="btn-cancel" onclick="hideConfirmModal()">Cancelar</button>
            <button class="btn-confirm-delete" onclick="handleDelete()">Deletar</button>
        </div>
    </div>
</div>

<div id="edit-card-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="hideEditCardModal()">&times;</span>
        <h2>Editar Cartão de Crédito</h2>
        <form id="edit-card-form" onsubmit="submitEditCard(event)">
            <input type="hidden" id="edit-card-id">
            
            <label for="edit-card-name">Nome do Cartão:</label>
            <input type="text" id="edit-card-name" required>
            
            <label for="edit-card-due-day">Dia de Vencimento:</label>
            <input type="number" id="edit-card-due-day" min="1" max="31" required>

            <button type="submit" class="btn-edit-submit">Salvar Alterações</button>
        </form>
    </div>
</div>

<div id="confirm-card-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="hideConfirmCardModal()">&times;</span>
        <h2>Confirmar Exclusão de Cartão</h2>
        <p>Tem certeza que deseja deletar este cartão? **As transações associadas serão convertidas para o método 'Dinheiro'**.</p>
        <div class="flex justify-end space-x-4 mt-4">
            <button class="btn-cancel" onclick="hideConfirmCardModal()">Cancelar</button>
            <button class="btn-confirm-delete" onclick="handleDeleteCard()">Deletar Cartão</button>
        </div>
    </div>
</div>

<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
    }
    .page-title {
        color: #2d3748;
        font-size: 2.5rem;
        font-weight: bold;
    }
    .month-selector select {
        padding: 8px 12px;
        border-radius: 9999px;
        border: 1px solid #e2e8f0;
        background-color: #f7fafc;
        appearance: none;
        cursor: pointer;
    }
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    .card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: flex;
        align-items: center;
    }
    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        margin-right: 15px;
    }
    .icon-receitas { background-color: #e0f2f1; color: #00796b; }
    .icon-despesas { background-color: #fbe9e7; color: #d84315; }
    .icon-saldo { background-color: #e3f2fd; color: #1e88e5; }
    .icon-cartao { background-color: #fff3e0; color: #ff9800; }
    .card-content {
        flex-grow: 1;
    }
    .card-content span {
        font-size: 0.9rem;
        color: #718096;
    }
    .card-content h2 {
        font-size: 1.75rem;
        font-weight: bold;
        margin: 0;
    }
    .text-success { color: #38a169; }
    .text-danger { color: #e53e3e; }
    .text-info { color: #3182ce; }
    .main-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
    }
    .section-card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .section-card h3 {
        color: #2d3748;
        font-weight: bold;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e2e8f0;
    }
    .transaction-list {
        list-style: none;
        padding: 0;
    }
    .transaction-list li {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #edf2f7;
    }
    .transaction-list li:last-child {
        border-bottom: none;
    }
    .transaction-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    .transaction-info {
        flex-grow: 1;
    }
    .transaction-info strong {
        display: block;
        color: #4a5568;
    }
    .transaction-info span {
        font-size: 0.8rem;
        color: #718096;
    }
    .transaction-value {
        font-weight: bold;
    }
    .no-data {
        color: #a0aec0;
        text-align: center;
        padding: 2rem;
    }
    .tabs {
        display: flex;
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 1rem;
    }
    .tab-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #718096;
        transition: color 0.2s;
    }
    .tab-btn.active {
        color: #2b6cb0;
        border-bottom: 2px solid #2b6cb0;
        margin-bottom: -2px;
    }
    .invoice-list {
        list-style: none;
        padding: 0;
    }
    .invoice-list li {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #edf2f7;
    }
    .invoice-list li:last-child {
        border-bottom: none;
    }
    .invoice-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        margin-right: 15px;
        background-color: #fbe9e7;
        color: #d84315;
    }

    /* Estilos dos Modais */
    .modal {
        display: none; 
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close-btn:hover, .close-btn:focus {
        color: #000;
        text-decoration: none;
    }
    .modal-content label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }
    .modal-content input, .modal-content select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
    }
    .btn-edit-submit, .btn-confirm-delete {
        background-color: #2196F3;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }
    .btn-cancel {
        background-color: #f44336;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }
</style>

<script>
    let transactionToDeleteId = null;
    let cardToDeleteId = null; // NOVO

    // --- Funções de Transação ---

    // Função para mostrar o modal de confirmação
    function showDeleteConfirm(id) {
        transactionToDeleteId = id;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // Função para esconder o modal de confirmação
    function hideConfirmModal() {
        document.getElementById('confirm-modal').style.display = 'none';
        transactionToDeleteId = null;
    }

    // Função para lidar com a exclusão após a confirmação
    async function handleDelete() {
        if (transactionToDeleteId) {
            deleteTransaction(transactionToDeleteId);
        }
        hideConfirmModal();
    }

    // Função para mostrar o modal de edição e preencher os campos com os dados da transação
    function showEditModal(id, description, amount, payment, category, type) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-description').value = description;
        document.getElementById('edit-amount').value = parseFloat(amount).toFixed(2);
        document.getElementById('edit-type').value = type;
        document.getElementById('edit-payment').value = payment;

        const categorySelect = document.getElementById('edit-category');
        categorySelect.innerHTML = '';
        const categories = ['Alimentação', 'Transporte', 'Moradia', 'Saúde', 'Lazer', 'Educação', 'Salário', 'Outros'];
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.text = cat;
            if (cat === category) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });

        document.getElementById('edit-modal').style.display = 'flex';
    }

    // Função para esconder o modal de edição
    function hideEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    // Função para enviar a requisição de edição (POST)
    async function submitEdit(event) {
        event.preventDefault();
        const id = document.getElementById('edit-id').value;
        const description = document.getElementById('edit-description').value;
        const amount = document.getElementById('edit-amount').value;
        const type = document.getElementById('edit-type').value;
        const payment = document.getElementById('edit-payment').value;
        const category = document.getElementById('edit-category').value;

        try {
            const response = await fetch(`/edit_transaction/${id}`, {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    description: description,
                    amount: amount,
                    type: type,
                    payment_method: payment,
                    category: category
                })
            });

            const result = await response.json();
            if (response.ok) {
                // Simplesmente recarregamos a página para ver a alteração
                window.location.reload();
            } else {
                alert('Erro ao atualizar a transação: ' + result.message);
            }
        } catch (error) {
            console.error('Ocorreu um erro ao conectar com o servidor.', error);
        }
    }

    // Função para enviar a requisição de exclusão (DELETE)
    async function deleteTransaction(id) {
        try {
            const response = await fetch(`/delete_transaction/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (response.ok) {
                // Remove o item da lista sem recarregar a página
                const transactionElement = document.querySelector(`li[data-id="${id}"]`);
                if (transactionElement) {
                    transactionElement.remove();
                }
            } else {
                console.error('Erro ao deletar a transação: ' + result.message);
            }
        } catch (error) {
            console.error('Ocorreu um erro ao conectar com o servidor.', error);
        }
    }
    
    // --- Funções de Cartão (NOVAS) ---
    
    // Exibir Modal de Edição de Cartão e buscar dados
    async function showEditCardModal(id) {
        try {
            const response = await fetch(`/get_card_details/${id}`);
            if (response.ok) {
                const card = await response.json();
                document.getElementById('edit-card-id').value = card.id;
                document.getElementById('edit-card-name').value = card.name;
                document.getElementById('edit-card-due-day').value = card.due_day;
                document.getElementById('edit-card-modal').style.display = 'flex';
            } else {
                alert('Erro ao buscar detalhes do cartão.');
            }
        } catch (error) {
            console.error('Erro ao buscar detalhes do cartão:', error);
        }
    }

    // Esconder Modal de Edição de Cartão
    function hideEditCardModal() {
        document.getElementById('edit-card-modal').style.display = 'none';
    }

    // Submeter Edição de Cartão
    async function submitEditCard(event) {
        event.preventDefault();
        const id = document.getElementById('edit-card-id').value;
        const name = document.getElementById('edit-card-name').value;
        const due_day = document.getElementById('edit-card-due-day').value;

        try {
            const response = await fetch(`/edit_card/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, due_day: due_day })
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                window.location.reload();
            } else {
                alert('Erro ao atualizar o cartão: ' + result.message);
            }
        } catch (error) {
            console.error('Ocorreu um erro ao conectar com o servidor.', error);
        }
    }

    // Mostrar modal de Confirmação de Exclusão de Cartão
    function showDeleteCardConfirm(id) {
        cardToDeleteId = id;
        document.getElementById('confirm-card-modal').style.display = 'flex';
    }

    // Esconder modal de Confirmação de Exclusão de Cartão
    function hideConfirmCardModal() {
        document.getElementById('confirm-card-modal').style.display = 'none';
        cardToDeleteId = null;
    }

    // Lidar com a exclusão do Cartão
    async function handleDeleteCard() {
        if (cardToDeleteId) {
            deleteCard(cardToDeleteId);
        }
        hideConfirmCardModal();
    }

    // Enviar a requisição de exclusão (DELETE) do Cartão
    async function deleteCard(id) {
        try {
            const response = await fetch(`/delete_card/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                window.location.reload();
            } else {
                console.error('Erro ao deletar o cartão: ' + result.message);
            }
        } catch (error) {
            console.error('Ocorreu um erro ao conectar com o servidor.', error);
        }
    }
    // --- Fim das Funções de Cartão ---

    // Adiciona o script de ícones Font Awesome para o HTML
    const fontAwesomeLink = document.createElement('link');
    fontAwesomeLink.rel = 'stylesheet';
    fontAwesomeLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css';
    document.head.appendChild(fontAwesomeLink);
</script>
{% endblock %}